<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CALCULADORA DE FILTROS MUNDOFAN A MEDIDA</title>
  <!-- Open Graph / WhatsApp preview -->
  <meta property="og:title" content="Calculadora de Filtros Mundofan">
  <meta property="og:description" content="Calculadora de filtros a medida Mundofan">
  <meta property="og:image" content="https://s4lv4th0r.github.io/calculadora-filtros-mundofan/mundofan.jpg">
  <meta property="og:url" content="https://s4lv4th0r.github.io/calculadora-filtros-mundofan/">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Tailwind CSS por CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="border-b bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between gap-4">
      <div class="min-w-0">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">CALCULADORA DE FILTROS MUNDOFAN A MEDIDA</h1>
        <p class="text-sm text-slate-600 mt-1">
          Selecciona un modelo, elige el espesor y añade Altura × Base (mm). La app redondea hacia arriba a la medida disponible más cercana.
        </p>
      </div>

      <div class="shrink-0 flex items-center gap-3">
        <div id="imgWarn" class="hidden text-xs text-amber-800 bg-amber-50 border border-amber-200 rounded-xl px-3 py-2">
          ⚠️ Algunas imágenes no se han encontrado. Revisa nombres/extensiones y que estén en la misma carpeta que el HTML.
        </div>
        <img id="logoImg" alt="MundoFan" class="h-10 sm:h-12 w-auto object-contain" />
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8">
    <!-- Step 1: Model selection -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 sm:p-6">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-lg font-semibold">1) Elige el modelo de filtro</h2>
          <p class="text-sm text-slate-600 mt-1">Haz clic sobre una tarjeta para seleccionar el modelo.</p>
        </div>
        <div id="selectedModelPill" class="hidden text-sm px-3 py-1 rounded-full bg-slate-100 border">
          Seleccionado: <span class="font-medium" id="selectedModelName"></span>
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="modelGrid"></div>
    </section>

    <!-- Step 2 + 3: Thickness and measures -->
    <section class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Inputs -->
      <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border p-4 sm:p-6">
        <h2 class="text-lg font-semibold">2) Configura el filtro</h2>

        <!-- Thickness -->
        <div class="mt-4">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <label class="block text-sm font-medium">Espesor</label>
            <span id="thicknessHint" class="text-xs text-slate-500">Selecciona un modelo para ver espesores disponibles.</span>
          </div>

          <div id="thicknessGroup" class="mt-3 flex flex-wrap gap-2"></div>
        </div>

        <!-- Measures -->
        <div class="mt-6">
          <h3 class="text-sm font-medium">Medidas frontales (mm)</h3>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-700" for="altura">Altura (A)</label>
              <input id="altura" type="number" inputmode="numeric" min="1" step="1"
                class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                placeholder="Ej: 430" />
            </div>
            <div>
              <label class="block text-sm text-slate-700" for="base">Base (B)</label>
              <input id="base" type="number" inputmode="numeric" min="1" step="1"
                class="mt-1 w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
                placeholder="Ej: 610" />
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-3">
            <button id="calcBtn"
              class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-medium hover:bg-slate-800 active:bg-slate-950 disabled:opacity-40 disabled:cursor-not-allowed">
              Calcular precio
            </button>
            <button id="resetBtn"
              class="rounded-xl border px-4 py-2 text-sm font-medium hover:bg-slate-50">
              Limpiar
            </button>

            <div id="statusMsg" class="text-sm text-slate-600"></div>
          </div>
        </div>

        <!-- Rounding explanation -->
        <div class="mt-6 rounded-2xl border bg-slate-50 p-4">
          <h3 class="text-sm font-semibold">Cómo funciona el redondeo</h3>
          <p class="text-sm text-slate-600 mt-1">
            Se cruza <span class="font-medium">Altura (A)</span> × <span class="font-medium">Base (B)</span>.
            Si la medida exacta no está en la tabla, se <span class="font-medium">redondea hacia arriba</span> a la más cercana disponible
            y se usa el precio de esa combinación.
          </p>
        </div>
      </div>

      <!-- Result -->
      <aside class="bg-white rounded-2xl shadow-sm border p-4 sm:p-6">
        <h2 class="text-lg font-semibold">3) Resultado</h2>

        <div class="mt-4 space-y-3 text-sm">
          <div class="flex items-center justify-between gap-3">
            <span class="text-slate-600">Modelo</span>
            <span class="font-medium text-right" id="resModel">—</span>
          </div>
          <div class="flex items-center justify-between gap-3">
            <span class="text-slate-600">Espesor</span>
            <span class="font-medium" id="resThickness">—</span>
          </div>
          <div class="h-px bg-slate-200 my-2"></div>

          <div class="flex items-center justify-between gap-3">
            <span class="text-slate-600">Medida introducida</span>
            <span class="font-medium" id="resInput">—</span>
          </div>
          <div class="flex items-center justify-between gap-3">
            <span class="text-slate-600">Medida aplicada</span>
            <span class="font-medium" id="resRounded">—</span>
          </div>

          <div id="resWarn" class="hidden mt-2 rounded-xl border border-amber-200 bg-amber-50 p-3 text-amber-900">
            <div class="font-semibold text-sm">Aviso</div>
            <div class="text-sm mt-1" id="resWarnText"></div>
          </div>

          <div class="mt-4 rounded-2xl border bg-slate-50 p-4">
            <div class="text-slate-600 text-sm">Precio</div>
            <div class="text-3xl font-semibold tracking-tight mt-1" id="resPrice">—</div>
            <div class="text-xs text-slate-500 mt-1" id="resPriceNote">* Precios según tabla cargada.</div>
          </div>
        </div>
      </aside>
    </section>

    <footer class="mt-10 pb-10 text-center text-xs text-slate-500">
      © Jordi Salvador
    </footer>
  </main>

  <script>
    /******************************************************************
     * CARGA ROBUSTA DE IMÁGENES (soporta .jpg, .jpeg, .png, .webp)
     ******************************************************************/
    function setImgWithFallback(imgEl, baseNameOrFile, fallbackExts = ["jpg","jpeg","png","webp"]) {
      const warnEl = document.getElementById("imgWarn");
      const hasExt = /\.[a-z0-9]+$/i.test(baseNameOrFile);
      const candidates = [];

      if (hasExt) {
        candidates.push(baseNameOrFile);
        const base = baseNameOrFile.replace(/\.[a-z0-9]+$/i, "");
        for (const ext of fallbackExts) candidates.push(`${base}.${ext}`);
      } else {
        for (const ext of fallbackExts) candidates.push(`${baseNameOrFile}.${ext}`);
      }

      let idx = 0;
      const placeholder =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
          <rect width='100%' height='100%' fill='#f1f5f9'/>
          <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#64748b' font-family='Arial' font-size='22'>
            Imagen no encontrada
          </text>
        </svg>`);

      function tryNext() {
        if (idx >= candidates.length) {
          warnEl.classList.remove("hidden");
          imgEl.onerror = null;
          imgEl.src = placeholder;
          return;
        }
        imgEl.src = candidates[idx++];
      }

      imgEl.onerror = tryNext;
      tryNext();
    }

    // Logo
    setImgWithFallback(document.getElementById("logoImg"), "mundofan");

    /******************************************************************
     * MENSAJE PARA MEDIDA NO FABRICABLE (por debajo o por encima)
     ******************************************************************/
    const NOT_MANUFACTURABLE_MSG =
      "contactar con el departamento de Ventilación o dividir el filtro en partes.";

    /******************************************************************
     * TABLAS DE PRECIOS (desde "a medida.xlsx")
     ******************************************************************/
    const PRICE_TABLES = {
      alumifil: {
        name: "Alumifil",
        efficacies: ["G3"],
        imageBase: "alumifil",
        thicknessOptions: [10, 20, 25],
        tablesByThickness: {
          10: {
            a: [100,200,300,400,500,600,700,800,900,1000],
            b: [100,200,300,400,500,600,700,800,900,1000],
            prices: [
              [30,35,40,45,50,60,90,90,100,110],
              [35,35,40,47.5,65,70,95,100,100,110],
              [40,40,60,60,70,90,100,100,100,115],
              [45,47.5,60,90,90,100,100,110,120,120],
              [50,65,70,90,100,100,105,120,120,125],
              [60,70,90,100,100,105,110,125,130,135],
              [90,95,100,100,105,110,115,130,130,140],
              [90,100,100,110,120,125,130,135,135,140],
              [100,100,100,120,120,130,130,135,140,150],
              [110,110,115,120,125,135,140,140,150,170]
            ]
          },
          20: null,
          25: null
        }
      },
            plegafil: {
        name: "Plegafil",
        efficacies: ["G4"],
        imageBase: "plegafil",
        thicknessOptions: [47, 96],
        tablesByThickness: {
          48: {
          a: [100,200,300,400,500,600,690],
          b: [100,200,300,400,500,600,700,800,900,1000],
          prices: [
              [18.68,19.16,19.7,20.18,20.72,21.2,23.57,24.1,26.63,27.16],
              [19.16,20.4,21.37,22.33,23.35,26.2,27.16,30.22,31.19,43.64],
              [19.7,21.37,23.03,24.48,27.86,29.31,32.8,34.25,47.45,48.15],
              [20.18,22.33,24.48,28.5,30.49,34.46,36.4,50.3,51.27,53.2],
              [20.72,23.35,27.86,30.49,35.16,37.58,52.18,53.36,55.78,61.95],
              [21.2,26.2,29.31,34.46,37.58,53.09,54.54,57.44,64.1,66.99],
              [23.57,27.16,32.8,36.4,52.18,54.54,58.14,65.28,68.61,71.99]
            ]
          },
          96: {
          a: [100,200,300,400,500,600,690],
          b: [100,200,300,400,500,600,700,800,900,1000],
          prices: [
              [25.02,25.55,26.57,27.11,28.13,28.67,31.94,32.96,36.88,37.9],
              [25.55,27,29.04,30.06,32.05,35.86,36.83,42.25,43.27,60.07],
              [26.57,29.04,31.51,33.01,38.76,40.26,45.15,48.15,64.47,67.48],
              [27.11,30.06,33.01,38.7,42.68,48.1,50.08,68.87,70.86,74.83],
              [28.13,32.05,38.76,42.68,50.03,52.5,72.31,74.78,77.25,87.77],
              [28.67,35.86,40.26,48.1,52.5,71.72,74.72,80.68,89.17,95.12],
              [31.94,36.83,45.15,50.08,72.31,74.72,79.66,92.12,95.55,102.53]
            ]
          }
        }
      },
          96: {
            a: [100,200,300,400,500,600,700],
            b: [100,200,300,400,500,600,700,800,900,1000],
            prices: [
              [30.97542592,31.780342459999997,32.69262208,33.49753862,34.40981824,35.21473478,39.18734938,40.099629,44.3413268,45.14624334],
              [33.49753862,34.19407852,35.10635814,35.91127468,36.8235543,37.62847084,41.225858139999996,42.138137760000005,46.00396272,46.80887926],
              [35.64480156,36.34134146,37.25362108,38.05853762,38.97081724,39.77573378,43.3194398,44.23171942,47.72128112,48.526197660000005],
              [37.68262976,38.37916966,39.29144928,40.09636582,41.00864544,41.81356198,45.52138964,46.43366926,49.65429824,50.45921478],
              [39.77573378,40.47227368,41.3845533,42.18946984,43.10174946,43.906666,47.82602112,48.73830074,51.3196178,52.12453434],
              [41.97617776,42.67271766,43.58499728,44.38991382,45.30219344,46.10710998,49.91829616,50.83057578,55.4539386,56.258855140000005],
              [44.1234407,44.8199806,45.73226022,46.53717676,47.44945638,48.25437292,52.07090886,52.98318848,56.47317452,57.27809106]
            ]
          }
        }
      },
            plegacard: {
        name: "Plegacard",
        efficacies: ["G4"],
        imageBase: "plegacard",
        thicknessOptions: [47, 96],
        tablesByThickness: {
          48: {
          a: [100,200,300,400,500,600,700,800,900,1000],
          b: [100,200,300,400,500,600,700,800,900,1000],
          prices: [
              [13.52,14.71,16.28,18.15,20.03,26.92,29.73,32.36,35.06,38.5],
              [14.71,15.96,17.72,20.03,21.91,29.11,32.24,35.37,38.19,41.94],
              [17.72,17.72,20.97,23.47,25.67,31.61,35.06,38.5,41.63,45.7],
              [18.15,20.03,23.47,25.04,27.54,33.8,37.56,41.32,44.76,48.83],
              [20.03,21.91,25.67,27.54,29.73,36.31,40.38,44.13,47.89,52.27],
              [26.92,29.11,31.61,33.8,36.31,38.81,43.19,47.57,51.33,56.03],
              [29.73,32.24,35.06,37.56,40.38,43.19,47.57,52.27,56.65,61.97],
              [32.36,35.37,38.5,41.32,44.13,47.57,52.27,53.21,57.28,62.6],
              [35.06,38.19,41.63,44.76,47.89,51.33,56.65,57.28,49.45,53.83],
              [38.5,41.94,45.7,48.83,52.27,56.03,61.97,62.6,53.83,54.46]
            ]
          },
          98: {
          a: [100,200,300,400,500,600,700,800,900,1000],
          b: [100,200,300,400,500,600,700,800,900,1000],
          prices: [
              [16.71,19.09,22.22,25.98,29.73,43.19,48.83,54.46,59.78,66.35],
              [19.09,21.6,25.04,29.42,33.18,47.57,53.83,60.09,65.73,72.93],
              [22.22,25.04,31.3,35.99,40.69,52.27,58.84,65.73,71.99,79.81],
              [25.98,29.42,35.99,39.44,44.13,56.34,63.54,71.05,77.62,85.76],
              [29.73,33.18,40.69,44.13,47.57,60.72,68.55,76.37,83.26,92.33],
              [43.19,47.57,52.27,56.34,60.72,65.42,74.18,82.63,90.14,99.53],
              [48.83,53.83,58.84,63.54,68.55,74.18,82,91.71,99.53,110.17],
              [54.46,60.09,65.73,71.05,76.37,82.63,91.71,92.96,100.78,111.43],
              [59.78,65.73,71.99,77.62,83.26,90.14,99.53,100.78,102.66,112.05],
              [66.35,72.93,79.81,85.76,92.33,99.53,110.17,111.43,112.05,114.56]
            ]
          }
        }
      },
          98: {
            a: [100,200,300,400,500,600,700,800,900,1000],
            b: [100,200,300,400,500,600,700,800,900,1000],
            prices: [
              [31.6,31.6,31.6,32.25,33.45,33.45,34.8,34.8,36.8,36.8],
              [31.6,31.6,31.6,32.25,33.45,33.45,34.8,36.8,36.8,36.8],
              [31.6,31.6,31.6,32.25,33.45,34.8,36.8,36.8,36.8,36.8],
              [32.25,32.25,32.25,33.45,34.8,36.8,36.8,36.8,39.15,39.15],
              [33.45,33.45,33.45,34.8,36.8,36.8,39.15,39.15,39.15,41.25],
              [33.45,33.45,34.8,36.8,36.8,39.15,41.25,41.25,41.25,43.2],
              [34.8,34.8,36.8,36.8,39.15,41.25,43.2,43.2,45.2,45.2],
              [34.8,36.8,36.8,36.8,39.15,41.25,43.2,45.2,45.2,47.6],
              [36.8,36.8,36.8,39.15,39.15,41.25,45.2,45.2,47.6,47.6],
              [36.8,36.8,36.8,39.15,41.25,43.2,45.2,47.6,47.6,47.6]
            ]
          }
        }
      },
            minifil: {
        name: "Minifil-e",
        efficacies: ["ePM10 70% (M6)", "ePM1 55% (F7)", "ePM1 70% (F8)", "ePM1 80% (F9)"],
        imageBase: "minifil",
        thicknessOptions: [47, 96],
        tablesByThickness: {
          48: {
          a: [100,200,300,400,500,600,700,800],
          b: [100,200,300,400,500,600,700,800,900,1000],
          prices: [
              [39.01,42.16,45.31,48.3,51.45,54.5,57.59,60.69,79.85,82.95],
              [41.9,46.73,51.71,56.54,61.48,66.68,71.19,76.13,89.25,103.43],
              [44.63,51.45,58.16,64.58,73.87,84.79,91.88,98.7,126.11,133.67],
              [47.62,55.46,64.05,78.23,88.2,98.18,106.63,128.1,152.25,167.32],
              [53.03,62.46,77.18,88.73,99.28,115.5,130.73,143.33,178.5,190.73],
              [55.13,65.63,85.05,96.6,110.15,130.73,135.98,149.36,190.68,213.05],
              [56.12,70.19,91.19,108.52,125.74,146.21,164.48,181.65,221.08,247.8],
              [60.03,80.85,105.74,123.64,142.07,160.55,179.66,202.07,247.64,278.78]
            ]
          },
          98: {
          a: [100,200,300,400,500,600,700,800],
          b: [100,200,300,400,500,600,700,800,900,1000],
          prices: [
              [39.8,46.58,53.31,60.03,66.81,73.59,82.27,88.41,102.31,109.09],
              [46.58,58.1,70.45,81.22,91.3,101.38,111.67,121.12,153.3,163.91],
              [53.31,70.45,84.89,98.44,112.46,126,145.32,159.34,175.09,221.92],
              [60.03,82.8,105.51,124.58,143.9,168.53,187.22,201.86,247.85,267.38],
              [66.81,95.15,117.08,145.43,168,195.56,218.35,236.67,289.28,318.1],
              [76.9,107.1,135.45,165.22,198.45,227.85,259.98,281.72,336,358.31],
              [83.07,117.34,149.42,185.85,218.4,254.94,285.81,315,377.16,416.9],
              [89.8,129.15,169.16,204.23,241.5,278.78,323.77,355.95,441,476.18]
            ]
          }
        }
      }

    };

    // Alumifil: misma tabla para 20/25
    PRICE_TABLES.alumifil.tablesByThickness[20] = PRICE_TABLES.alumifil.tablesByThickness[10];
    PRICE_TABLES.alumifil.tablesByThickness[25] = PRICE_TABLES.alumifil.tablesByThickness[10];

    /******************************************************************
     * LÓGICA DE PRECIOS
     ******************************************************************/
    function mapThicknessToTable(modelKey, thicknessUI) {
      if (modelKey === "alumifil") return thicknessUI;
      if (thicknessUI === 47) return 48;
      if (thicknessUI === 96) {
        if (modelKey === "plegacard" || modelKey === "minifil") return 98;
        return 96;
      }
      return thicknessUI;
    }

    // ✅ CAMBIO PEDIDO:
    // - Si input < mínimo => fuera de tabla (no fabricable), no se redondea, no hay precio
    // - Si input > máximo => fuera de tabla, no hay precio
    // - Si está dentro, y no existe, redondeo hacia arriba.
    function clampAndRoundUpToAvailable(input, available) {
      const sorted = [...available].sort((a,b)=>a-b);
      const min = sorted[0];
      const max = sorted[sorted.length - 1];

      if (input < min) {
        return { value: input, warn: NOT_MANUFACTURABLE_MSG, outOfTable: true };
      }

      for (const v of sorted) {
        if (v >= input) {
          return {
            value: v,
            warn: v !== input ? `No existe ${input} mm en tabla. Se redondea hacia arriba a ${v} mm.` : null,
            outOfTable: false
          };
        }
      }

      // input > max
      return { value: input, warn: NOT_MANUFACTURABLE_MSG, outOfTable: true };
    }

    function formatEUR(value) {
      if (typeof value !== "number" || Number.isNaN(value)) return "—";
      return new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(value);
    }

    function getPrice(modelKey, thicknessUI, altura, base) {
      const model = PRICE_TABLES[modelKey];
      if (!model) throw new Error("Modelo no válido.");

      const thicknessTable = mapThicknessToTable(modelKey, thicknessUI);
      const table = model.tablesByThickness[thicknessTable];
      if (!table) throw new Error("No hay tabla para ese espesor.");

      const aRes = clampAndRoundUpToAvailable(altura, table.a);
      const bRes = clampAndRoundUpToAvailable(base, table.b);

      const outOfTable = aRes.outOfTable || bRes.outOfTable;

      const warnings = Array.from(new Set([aRes.warn, bRes.warn].filter(Boolean)));
if (outOfTable) {
        return {
          price: null,
          roundedA: aRes.value,
          roundedB: bRes.value,
          warnings,
          outOfTable: true
        };
      }

      const aIdx = table.a.indexOf(aRes.value);
      const bIdx = table.b.indexOf(bRes.value);
      const price = table.prices[aIdx]?.[bIdx];
      if (typeof price !== "number") throw new Error("No se encontró precio para la combinación.");

      return {
        price,
        roundedA: aRes.value,
        roundedB: bRes.value,
        warnings,
        outOfTable: false
      };
    }

    /******************************************************************
     * UI STATE
     ******************************************************************/
    let selectedModelKey = null;
    let selectedThickness = null;

    const modelGrid = document.getElementById("modelGrid");
    const thicknessGroup = document.getElementById("thicknessGroup");
    const thicknessHint = document.getElementById("thicknessHint");

    const selectedModelPill = document.getElementById("selectedModelPill");
    const selectedModelName = document.getElementById("selectedModelName");

    const alturaEl = document.getElementById("altura");
    const baseEl = document.getElementById("base");

    const calcBtn = document.getElementById("calcBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusMsg = document.getElementById("statusMsg");

    const resModel = document.getElementById("resModel");
    const resThickness = document.getElementById("resThickness");
    const resInput = document.getElementById("resInput");
    const resRounded = document.getElementById("resRounded");
    const resPrice = document.getElementById("resPrice");
    const resWarn = document.getElementById("resWarn");
    const resWarnText = document.getElementById("resWarnText");
    const resPriceNote = document.getElementById("resPriceNote");

    function setStatus(message, kind="info") {
      statusMsg.textContent = message || "";
      statusMsg.className = "text-sm";
      if (!message) return statusMsg.classList.add("text-slate-600");
      if (kind === "error") statusMsg.classList.add("text-red-700");
      else if (kind === "ok") statusMsg.classList.add("text-emerald-700");
      else statusMsg.classList.add("text-slate-600");
    }

    function renderModels() {
      modelGrid.innerHTML = "";
      const entries = Object.entries(PRICE_TABLES);

      for (const [key, model] of entries) {
        const card = document.createElement("button");
        card.type = "button";
        card.className =
          "text-left rounded-2xl border bg-white hover:bg-slate-50 shadow-sm overflow-hidden " +
          "transition focus:outline-none focus:ring-2 focus:ring-slate-300";

        if (selectedModelKey === key) card.classList.add("ring-2", "ring-slate-900", "border-slate-900");

        const effHtml = model.efficacies
          .map(e => `<span class="inline-flex items-center rounded-full border bg-white px-2 py-0.5 text-xs text-slate-700">${e}</span>`)
          .join("");

        card.innerHTML = `
          <div class="aspect-[4/3] bg-slate-100 overflow-hidden">
            <img class="h-full w-full object-cover" alt="${model.name}" />
          </div>
          <div class="p-4">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold text-base leading-tight">${model.name}</div>
                <div class="text-xs text-slate-600 mt-1">Selecciona para calcular</div>
              </div>
              <div class="shrink-0 text-xs px-2 py-1 rounded-full border bg-slate-50">
                ${model.thicknessOptions.join("/")} mm
              </div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">${effHtml}</div>
          </div>
        `;

        const img = card.querySelector("img");
        setImgWithFallback(img, model.imageBase, ["jpg","jpeg","png","webp"]);

        card.addEventListener("click", () => {
          selectedModelKey = key;
          selectedThickness = null;
          renderModels();
          renderThicknessOptions();
          updateSelectedPill();
          updateCalcButtonState();
          setStatus("Modelo seleccionado. Ahora elige el espesor y añade medidas.", "ok");
        });

        modelGrid.appendChild(card);
      }
    }

    function updateSelectedPill() {
      if (!selectedModelKey) {
        selectedModelPill.classList.add("hidden");
        selectedModelName.textContent = "";
        return;
      }
      selectedModelPill.classList.remove("hidden");
      selectedModelName.textContent = PRICE_TABLES[selectedModelKey].name;
    }

    function renderThicknessOptions() {
      thicknessGroup.innerHTML = "";
      resWarn.classList.add("hidden");
      resWarnText.textContent = "";

      if (!selectedModelKey) {
        thicknessHint.textContent = "Selecciona un modelo para ver espesores disponibles.";
        return;
      }

      const model = PRICE_TABLES[selectedModelKey];
      thicknessHint.textContent = "Elige el espesor disponible para este modelo.";

      for (const t of model.thicknessOptions) {
        const btn = document.createElement("button");
        btn.type = "button";
        const isSel = selectedThickness === t;

        btn.className =
          "px-3 py-2 rounded-xl border text-sm font-medium transition " +
          (isSel ? "bg-slate-900 text-white border-slate-900" : "bg-white hover:bg-slate-50");

        btn.textContent = `${t} mm`;
        btn.addEventListener("click", () => {
          selectedThickness = t;
          renderThicknessOptions();
          updateCalcButtonState();
          setStatus("Espesor seleccionado. Puedes calcular el resultado.", "ok");
        });

        thicknessGroup.appendChild(btn);
      }
    }

    function clearResult() {
      resModel.textContent = "—";
      resThickness.textContent = "—";
      resInput.textContent = "—";
      resRounded.textContent = "—";
      resPrice.textContent = "—";
      resPriceNote.textContent = "* Precios según tabla cargada.";
      resWarn.classList.add("hidden");
      resWarnText.textContent = "";
    }

    function updateCalcButtonState() {
      const a = Number(alturaEl.value);
      const b = Number(baseEl.value);
      calcBtn.disabled = !(selectedModelKey && selectedThickness && Number.isFinite(a) && a > 0 && Number.isFinite(b) && b > 0);
    }

    function calculate() {
      try {
        setStatus("", "info");
        resWarn.classList.add("hidden");
        resWarnText.textContent = "";

        if (!selectedModelKey) throw new Error("Selecciona un modelo.");
        if (!selectedThickness) throw new Error("Selecciona un espesor.");

        const a = Math.round(Number(alturaEl.value));
        const b = Math.round(Number(baseEl.value));
        if (!Number.isFinite(a) || a <= 0) throw new Error("Altura (A) inválida.");
        if (!Number.isFinite(b) || b <= 0) throw new Error("Base (B) inválida.");

        const model = PRICE_TABLES[selectedModelKey];
        const result = getPrice(selectedModelKey, selectedThickness, a, b);

        resModel.textContent = model.name;
        resThickness.textContent = `${selectedThickness} mm`;
        resInput.textContent = `${a} × ${b} mm`;
        resRounded.textContent = `${result.roundedA} × ${result.roundedB} mm`;

        if (result.outOfTable) {
          resPrice.textContent = "—";
          resPriceNote.textContent = "Medida fuera de tabla: no se muestra precio.";
        } else {
          resPrice.textContent = formatEUR(result.price);
          resPriceNote.textContent = "* Precios según tabla cargada.";
        }

        if (result.warnings.length) {
          resWarn.classList.remove("hidden");
          resWarnText.textContent = result.warnings.join(" ");
        }

        setStatus(result.outOfTable ? "Medida fuera de tabla. Precio no disponible." : "Precio calculado correctamente.", result.outOfTable ? "info" : "ok");
      } catch (e) {
        clearResult();
        setStatus(e?.message || "Error al calcular.", "error");
      }
    }

    function resetAll() {
      selectedModelKey = null;
      selectedThickness = null;
      alturaEl.value = "";
      baseEl.value = "";
      setStatus("", "info");
      clearResult();
      renderModels();
      renderThicknessOptions();
      updateSelectedPill();
      updateCalcButtonState();
    }

    calcBtn.addEventListener("click", calculate);
    resetBtn.addEventListener("click", resetAll);
    alturaEl.addEventListener("input", updateCalcButtonState);
    baseEl.addEventListener("input", updateCalcButtonState);

    // Init
    renderModels();
    renderThicknessOptions();
    updateSelectedPill();
    clearResult();
    updateCalcButtonState();
  </script>
</body>
</html>